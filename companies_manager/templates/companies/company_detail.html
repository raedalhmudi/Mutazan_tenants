{% extends "companies/base_site.html" %}
{% load static %} 
{% block sidebar %}
  {{ block.super }}
{% endblock %} 
{% block content %}

<style>
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø§Øª */
h2, h4 {
    font-weight: bold;
    margin-bottom: 20px;
}
@media (min-width: 992px) {
    .container, .container-lg, .container-md, .container-sm {
        max-width: 1500px;
    }
}
button.btn-info, button.btn-success, button.btn-primary {
    margin-right: 10px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
.nav-tabs .nav-link.active {
    background-color: #17a2b8;
    color: white;
    font-weight: bold;
}
.nav-tabs .nav-link {
    color: #17a2b8;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.b-table {
    margin-top: 20px;
    border-radius: 10px;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.table-wrapper {
    overflow-x: auto;
}

.table.is-fullwidth {
    width: 100%;
    border-collapse: collapse;
}

.table.is-striped tbody tr:nth-child(even) {
    background-color: #f9f9f9;
}

.table.is-hoverable tbody tr:hover {
    background-color: #f5f5f5;
}

.table th, .table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #363636;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© */
.image img.is-rounded {
    border-radius: 50%;
    width: 32px;
    height: 32px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
.progress.is-small {
    height: 8px;
}

.progress.is-primary {
    background-color: #ededed;
}

.progress.is-primary::-webkit-progress-value {
    background-color: #00d1b2;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.buttons.is-right {
    justify-content: flex-end;
}

.button.is-small {
    padding: 0.25em 0.5em;
    font-size: 0.75rem;
}

.button.is-primary {
    background-color: #00d1b2;
    border-color: transparent;
    color: #fff;
}

.button.is-danger {
    background-color: #ff3860;
    border-color: transparent;
    color: #fff;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙØ­Ø§Øª */
.notification {
    background-color: #f5f5f5;
    border-radius: 0 0 6px 6px;
    padding: 1rem;
}

.level {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.buttons.has-addons .button {
    margin-right: -1px;
    border-radius: 0;
}

.buttons.has-addons .button:first-child {
    border-radius: 4px 0 0 4px;
}

.buttons.has-addons .button:last-child {
    border-radius: 0 4px 4px 0;
}

.buttons.has-addons .button.is-active {
    background-color: #00d1b2;
    color: white;
}

/* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
.tab-content {
    margin-top: 20px;
}

/* Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨ */
.has-text-grey.is-abbr-like {
    font-size: 0.85rem;
    color: #666;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
.report-dropdown {
    position: relative;
    display: inline-block;
    margin-bottom: 15px;
}
.report-dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 280px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1000;
    border-radius: 5px;
    padding: 15px;
    left: 0;
    top: 100%;
}

.report-dropdown:hover .report-dropdown-content {
    display: block;
}
/* Ù…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
html {
    overflow-x: hidden;
}
/* Ø¶Ø¨Ø· ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ */
.container {
    position: relative;
    z-index: 1;
}
/* Ø¶Ø¨Ø· Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø­ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.report-dropdown-btn {
    background-color: #17a2b8;
    color: white;
    padding: 10px 15px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    font-weight: bold;
}

.report-dropdown-content.show {
    display: block;
}

.report-fields {
    margin-top: 10px;
    background: white;
    padding: 10px;
    border-radius: 5px;
}

.refresh-icon {
    float: left;
    cursor: pointer;
    margin-left: 10px;
    font-size: 20px;
    color: #17a2b8;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.refresh-icon {
    cursor: pointer;
    font-size: 20px;
    color: #17a2b8;
    transition: transform 0.3s ease;
    padding: 5px;
    border-radius: 50%;
}

.refresh-icon:hover {
    background-color: #f0f0f0;
}

.refresh-icon:active {
    transform: rotate(360deg);
}


/* ØªØ­Ø³ÙŠÙ† Ø¸Ù‡ÙˆØ± Ø­Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
#fetch-status, #fetch-status-violations {
    font-weight: bold;
    margin-right: 10px;
    transition: all 0.3s ease;
}

</style>

<div class="container mt-4">
    <link rel="stylesheet" href="{% static 'common/css/companies_manager/company_detail.css' %}">
    
    <h2>{{ company.name }}</h2>

    <!-- Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
    <div class="report-dropdown">
        <button class="report-dropdown-btn">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <div class="report-dropdown-content">
            <button class="btn btn-info btn-block" id="daily-report">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</button>
            <button class="btn btn-info btn-block" id="weekly-report">ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
            <button class="btn btn-info btn-block" id="monthly-report">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</button>
            <button id="print-report" class="btn btn-success btn-block">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            
            <!-- Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
            <div id="daily-fields" class="report-fields">
                <label for="daily-date">Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
                <input type="date" id="daily-date" class="form-control" value="{{ today|date:'Y-m-d' }}">
            </div>

            <!-- Ø­Ù‚ÙˆÙ„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ -->
            <div id="weekly-fields" class="report-fields" style="display: none;">
                <label for="from-date">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="from-date" class="form-control">
                <label for="to-date">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="to-date" class="form-control">
            </div>

            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ -->
            <div id="monthly-fields" class="report-fields" style="display: none;">
                <label for="month-select">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
                <select id="month-select" class="form-control">
                    {% for month in months %}
                    <option value="{{ month.value }}" {% if month.selected %}selected{% endif %}>{{ month.name }}</option>
                    {% endfor %}
                </select>
                <label for="year-select">Ø§Ù„Ø³Ù†Ø©:</label>
                <select id="year-select" class="form-control">
                    {% for year in years %}
                    <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>


<ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="weight-cards-tab" data-toggle="tab" href="#weight-cards" role="tab" aria-controls="weight-cards" aria-selected="true">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ù†Ù‚ÙˆÙ„Ø©</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="violations-tab" data-toggle="tab" href="#violations" role="tab" aria-controls="violations" aria-selected="false">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</a>
    </li>
</ul>

<div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="weight-cards" role="tabpanel" aria-labelledby="weight-cards-tab">
        <div class="card-content">
            <div class="b-table has-pagination">
                <div class="table-header">
                    <h4>Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙˆØ²Ù†</h4>
                    <span id="fetch-status" style="font-weight: bold;"></span>
                    <i class="refresh-icon" id="refresh-data" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„</i>
                </div>
                <div class="table-wrapper has-mobile-cards">
                    <table class="table is-fullwidth is-striped is-hoverable">
                        <thead>
                            <tr>
                                <th class="is-checkbox-cell">
                                    <label class="b-checkbox checkbox">
                                        <input type="checkbox" value="false">
                                        <span class="check"></span>
                                    </label>
                                </th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>
                                <th>Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙØ§Ø±Øº</th>
                                <th>Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø­Ù…Ù„</th>
                                <th>Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠÙ‡</th>
                                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="weight-cards-body">
                            {% if transferred_cards %}
                            {% for card in transferred_cards %}
                            {% if not card.violation_type %}
                            <tr>
                                <td class="is-checkbox-cell">
                                    <label class="b-checkbox checkbox">
                                        <input type="checkbox" value="false">
                                        <span class="check"></span>
                                    </label>
                                </td>
                                <td data-label="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©">{{ card.plate_number }}</td>
                                <td data-label="Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙØ§Ø±Øº">{{ card.empty_weight }}</td>
                                <td data-label="Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø­Ù…Ù„">{{ card.loaded_weight }}</td>
                                <td data-label="Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ">{{ card.net_weight }}</td>
                                <td data-label="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚">{{ card.driver_name }}</td>
                                <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„">
                                    <small class="has-text-grey is-abbr-like">{{ card.entry_date|date:"m/d/Y h:i A"|default:"-" }}</small>
                                </td>
                                <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬">
                                    <small class="has-text-grey is-abbr-like">{{ card.exit_date|date:"m/d/Y h:i A"|default:"-" }}</small>
                                </td>
                                <td data-label="Ø§Ù„ÙƒÙ…ÙŠÙ‡">{{ card.quantity }}</td>
                                <td data-label="Ø§Ù„Ù…Ø§Ø¯Ø©">{{ card.material }}</td>
                                <td data-label="Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
                                    <progress max="100" class="progress is-small is-primary" value="{% if card.status == 'Ù…ÙƒØªÙ…Ù„' %}100{% elif card.status == 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' %}50{% else %}10{% endif %}">
                                        {% if card.status == 'Ù…ÙƒØªÙ…Ù„' %}100{% elif card.status == 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' %}50{% else %}10{% endif %}
                                    </progress>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="11" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="notification">
                    <div class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <div class="buttons has-addons">
                                    <button type="button" class="button is-active">1</button>
                                    <button type="button" class="button">2</button>
                                    <button type="button" class="button">3</button>
                                </div>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <small>Ø§Ù„ØµÙØ­Ø© 1 Ù…Ù† 3</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <iframe id="print-frame" style="display: none; width: 100%;" frameborder="0"></iframe>
    
    <div class="tab-pane fade" id="violations" role="tabpanel" aria-labelledby="violations-tab">
        <div class="card-content">
            <div class="b-table has-pagination">
                <div class="table-header">
                    <h4>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h4>
                    <span id="fetch-status-violations" style="font-weight: bold;"></span>
                    <i class="refresh-icon" id="refresh-data-violations" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„</i>
                </div>
                <div class="table-wrapper has-mobile-cards">
                    <table class="table is-fullwidth is-striped is-hoverable">
                        <thead>
                            <tr>
                                <th class="is-checkbox-cell">
                                    <label class="b-checkbox checkbox">
                                        <input type="checkbox" value="false">
                                        <span class="check"></span>
                                    </label>
                                </th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th>
                                <th>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</th>
                                <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                <th>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ²Ù†</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="violations-body">
                            {% if transferred_cards %}
                            {% for card in transferred_cards %}
                            {% if card.violation_type %}
                            <tr>
                                <td class="is-checkbox-cell">
                                    <label class="b-checkbox checkbox">
                                        <input type="checkbox" value="false">
                                        <span class="check"></span>
                                    </label>
                                </td>
                                <td data-label="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©">{{ card.plate_number }}</td>
                                <td data-label="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©">{{ card.violation_type }}</td>
                                <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©">
                                    <small class="has-text-grey is-abbr-like">{{ card.timestamp|date:"m/d/Y h:i A"|default:"-" }}</small>
                                </td>
                                <td data-label="Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">{{ card.device_vio }}</td>
                                <td data-label="Ø§Ù„Ø¹Ù…Ù„ÙŠØ©">{{ card.entry_exit_log }}</td>
                                <td data-label="Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ²Ù†">{{ card.weight_card_vio }}</td>
                                <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                                    <progress max="100" class="progress is-small is-primary" value="{% if card.status == 'Ù…ÙƒØªÙ…Ù„' %}100{% elif card.status == 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' %}50{% else %}10{% endif %}">
                                        {% if card.status == 'Ù…ÙƒØªÙ…Ù„' %}100{% elif card.status == 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' %}50{% else %}10{% endif %}
                                    </progress>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="notification">
                    <div class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <div class="buttons has-addons">
                                    <button type="button" class="button is-active">1</button>
                                    <button type="button" class="button">2</button>
                                    <button type="button" class="button">3</button>
                                </div>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <small>Ø§Ù„ØµÙØ­Ø© 1 Ù…Ù† 3</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Ù…ØªØºÙŠØ± Ù„ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ


    // ØªØ­Ø³ÙŠÙ† ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«
    document.getElementById("refresh-data").addEventListener("click", function() {
        this.style.transform = "rotate(360deg)";
        setTimeout(() => {
            this.style.transform = "rotate(0deg)";
            fetchData('weight');
        }, 300);
    });
    
    document.getElementById("refresh-data-violations").addEventListener("click", function() {
        this.style.transform = "rotate(360deg)";
        setTimeout(() => {
            this.style.transform = "rotate(0deg)";
            fetchData('violations');
        }, 300);
    });
    let currentReportType = 'daily';
    
    // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    document.getElementById("daily-date").valueAsDate = new Date();
    
    // ØªØ¹ÙŠÙŠÙ† Ù†Ø·Ø§Ù‚ Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù…Ù† Ø§Ù„ÙŠÙˆÙ… Ø¥Ù„Ù‰ Ø¨Ø¹Ø¯ 7 Ø£ÙŠØ§Ù…)
    let today = new Date();
    let nextWeek = new Date();
    nextWeek.setDate(today.getDate() + 7);
    
    document.getElementById("from-date").valueAsDate = today;
    document.getElementById("to-date").valueAsDate = nextWeek;
    

    
    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById("daily-report").addEventListener("click", function() {
        currentReportType = 'daily';
        document.getElementById("daily-fields").style.display = "block";
        document.getElementById("weekly-fields").style.display = "none";
        document.getElementById("monthly-fields").style.display = "none";
    });
    
    document.getElementById("weekly-report").addEventListener("click", function() {
        currentReportType = 'weekly';
        document.getElementById("daily-fields").style.display = "none";
        document.getElementById("weekly-fields").style.display = "block";
        document.getElementById("monthly-fields").style.display = "none";
    });
    
    document.getElementById("monthly-report").addEventListener("click", function() {
        currentReportType = 'monthly';
        document.getElementById("daily-fields").style.display = "none";
        document.getElementById("weekly-fields").style.display = "none";
        document.getElementById("monthly-fields").style.display = "block";
    });
    
    document.getElementById("print-report").addEventListener("click", function() {
        let companyId = "{{ company.id }}";
        let url = `/companies/${companyId}/print-weight-cards/`;
        let params = [];
        
        // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        let activeTab = document.querySelector('.nav-tabs .active').id;
        let dataType = activeTab.includes('weight') ? 'weight_cards' : 'violations';
        params.push(`data_type=${dataType}`);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        if (currentReportType === 'daily') {
            let date = document.getElementById("daily-date").value;
            params.push(`report_type=daily&date=${date}`);
        } 
        else if (currentReportType === 'weekly') {
            let fromDate = document.getElementById("from-date").value;
            let toDate = document.getElementById("to-date").value;
            params.push(`report_type=weekly&from_date=${fromDate}&to_date=${toDate}`);
        } 
        else if (currentReportType === 'monthly') {
            let month = document.getElementById("month-select").value;
            let year = document.getElementById("year-select").value;
            params.push(`report_type=monthly&month=${month}&year=${year}`);
        }
        
        fetch(`${url}?${params.join('&')}`)
        .then(response => response.text())
        .then(html => {
            let iframe = document.getElementById("print-frame");
            let doc = iframe.contentWindow.document;
            doc.open();
            doc.write(html);
            doc.close();

            iframe.style.display = "none";
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
        })
        .catch(error => {
            console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:", error);
        });
    });

    // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function fetchData(tabType) {
        let fetchStatus = document.getElementById(tabType === 'weight' ? "fetch-status" : "fetch-status-violations");
        fetchStatus.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
    
        let companyId = "{{ company.id }}";
        let params = [];
        
        // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
        let dataType = tabType === 'weight' ? 'weight_cards' : 'violations';
        params.push(`data_type=${dataType}`);
        
        if (currentReportType === 'daily') {
            let date = document.getElementById("daily-date").value;
            params.push(`report_type=daily&date=${date}`);
        } 
        else if (currentReportType === 'weekly') {
            let fromDate = document.getElementById("from-date").value;
            let toDate = document.getElementById("to-date").value;
            params.push(`report_type=weekly&from_date=${fromDate}&to_date=${toDate}`);
        } 
        else if (currentReportType === 'monthly') {
            let month = document.getElementById("month-select").value;
            let year = document.getElementById("year-select").value;
            params.push(`report_type=monthly&month=${month}&year=${year}`);
        }
    
        fetch(`/companies/${companyId}/fetch-data/?${params.join('&')}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                fetchStatus.textContent = "âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!";
                
                if (dataType === 'weight_cards') {
                    let tableBody = document.getElementById("weight-cards-body");
                    tableBody.innerHTML = "";
                    data.cards.forEach(card => {
                        let entryDate = card.entry_date ? formatGregorianDate(card.entry_date) : '-';
                        let exitDate = card.exit_date ? formatGregorianDate(card.exit_date) : '-';
                        let progressValue = card.status === 'Ù…ÙƒØªÙ…Ù„' ? 100 : card.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' ? 50 : 10;
                        let row = `
                            <tr>
                                <td class="is-checkbox-cell">
                                    <label class="b-checkbox checkbox">
                                        <input type="checkbox" value="false">
                                        <span class="check"></span>
                                    </label>
                                </td>
                                <td data-label="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©">${card.plate_number || ''}</td>
                                <td data-label="Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙØ§Ø±Øº">${card.empty_weight || ''}</td>
                                <td data-label="Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø­Ù…Ù„">${card.loaded_weight || ''}</td>
                                <td data-label="Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ">${card.net_weight || ''}</td>
                                <td data-label="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚">${card.driver_name || ''}</td>
                                <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„">
                                    <small class="has-text-grey is-abbr-like">${entryDate}</small>
                                </td>
                                <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬">
                                    <small class="has-text-grey is-abbr-like">${exitDate}</small>
                                </td>
                                <td data-label="Ø§Ù„ÙƒÙ…ÙŠÙ‡">${card.quantity || ''}</td>
                                <td data-label="Ø§Ù„Ù…Ø§Ø¯Ø©">${card.material || ''}</td>
                                <td data-label="Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
                                    <progress max="100" class="progress is-small is-primary" value="${progressValue}">
                                        ${progressValue}
                                    </progress>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } else {
                    let tableBody = document.getElementById("violations-body");
                    tableBody.innerHTML = "";
                    data.cards.forEach(card => {
                        let timestamp = card.timestamp ? formatGregorianDate(card.timestamp) : '-';
                        let progressValue = card.status === 'Ù…ÙƒØªÙ…Ù„' ? 100 : card.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' ? 50 : 10;
                        let row = `
                            <tr>
                                <td class="is-checkbox-cell">
                                    <label class="b-checkbox checkbox">
                                        <input type="checkbox" value="false">
                                        <span class="check"></span>
                                    </label>
                                </td>
                                <td data-label="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©">${card.plate_number || ''}</td>
                                <td data-label="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©">${card.violation_type || ''}</td>
                                <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©">
                                    <small class="has-text-grey is-abbr-like">${timestamp}</small>
                                </td>
                                <td data-label="Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">${card.device_vio || ''}</td>
                                <td data-label="Ø§Ù„Ø¹Ù…Ù„ÙŠØ©">${card.entry_exit_log || ''}</td>
                                <td data-label="Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ²Ù†">${card.weight_card_vio || ''}</td>
                                <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                                    <progress max="100" class="progress is-small is-primary" value="${progressValue}">
                                        ${progressValue}
                                    </progress>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                }
            } else {
                fetchStatus.textContent = "âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!";
            }
        })
        .catch(error => {
            fetchStatus.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!";
            console.error(error);
        });
    }

    // Ø£Ø­Ø¯Ø§Ø« Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
    document.getElementById("refresh-data").addEventListener("click", function() {
        fetchData('weight');
    });
    
    document.getElementById("refresh-data-violations").addEventListener("click", function() {
        fetchData('violations');
    });

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„
    function formatGregorianDate(dateString) {
        if (!dateString) return '-';
        
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true,
            numberingSystem: 'latn'
        };
        
        return date.toLocaleString('en-US', options)
                   .replace(/,/g, '')
                   .replace(/\//g, '-');
    }
});
</script>
    
{% endblock %}